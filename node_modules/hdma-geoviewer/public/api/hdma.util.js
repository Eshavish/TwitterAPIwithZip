if(!window.hdma){window.hdma={}}

hdma.util={
	/**
	 * convert javascript object to html
	 * @param {Object} obj
	 * @param {Array} notShowArray is an array of string which is not shown in the html
	 * @return {String} html string
	 */
	objectToHtml: function(obj, notShowArray){
		if(!obj){console.log("[ERROR]hdma.util.objectToHtml: obj is null!");return;}

		if(!notShowArray){notShowArray=[]}

		var html="<ul class='objToHtml'>";
		for(var k in obj){
			//if k (a property) is not in the notShowArray($.inArray(k, notShowArray)==-1)
			if($.inArray(k, notShowArray)==-1){
				html+="<li><b>"+k+"</b>: " + obj[k] + "</li>";
			}
		}
		html+="</ul>";

		return html;
	},



	/**
	 *  highlight keyword
	 */
	highlightKeyword: function(keywords, html){
		//highlight keyword
		var rgxp,rep1;
		$.each(keywords, function(j,keyword){
			keyword=keyword.replace(/\"/gi,"")
			rgxp = new RegExp(keyword, 'ig');
			repl = '<span class="highlightKeyword">' + keyword + '</span>';
			html = html.replace(rgxp, repl);
		});
		return html;
	},


	/**
	 * cappital first letter
	 */
	capitalizeFirstLetter: function(s){
		return s.charAt(0).toUpperCase() + s.slice(1);
	},



	/**
	 * read all features properies in the cluster
	 */
	readClusterFeatureProperies: function(clusterObj, properties, propertyName){
		if(clusterObj._markers && clusterObj._markers.length>0){
			$.each(clusterObj._markers, function(i,marker){
				properties.push(marker[propertyName]);
			});
		}

		if(clusterObj._childClusters && clusterObj._childClusters.length>0){
			$.each(clusterObj._childClusters, function(i,cluster){
				properties.concat(hdma.util.readClusterFeatureProperies(cluster, properties, propertyName));
			});
		}
		return properties;
	},


	/**
	 * parse geojsonProperties to Array
	 * @param {GEOJSON} geojson can be featureColleciton or a feature
	 * @return {Object} containing {columns: an array of titles, datas: an array of properties}
	 */
	geojsonPropertiesToArray: function(geojson, options){
		if(!geojson){console.log("[ERROR] hdma.util.geoJsonPropertiesToArray: no geojson");return;}

		var obj={
			columns_dataTable:[],
			columns:[],
			datas:[],
			googleChartData:[],
			statisticsColumn:{}
		}

		//options
		if(!options){options={}}
		options.statisticsColumn=options.statisticsColumn || null

		if(options.statisticsColumn){
			obj.statisticsColumn[options.statisticsColumn]={
				"sum":0
			};
		}


		//if geojson is an array
		if(geojson instanceof Array){
			geojson={type:"FeatureCollection", features:geojson};
		}


		//geojson is featureCollection
		if(geojson.type.toUpperCase()=='FEATURECOLLECTION'){
				$.each(geojson.features, function(i, feature){
					//get columns
					if(i==0){
						var temp=parseFeature(i, feature, true);
						obj.columns_dataTable=temp.columns_dataTable;
						obj.columns=temp.columns;
						obj.datas.push(temp.datas);
					}else{
						obj.datas.push(parseFeature(i, feature, false).datas)
					}

					//statistics
					if(options.statisticsColumn){
						obj.statisticsColumn[options.statisticsColumn]['sum']+=parseFloat(feature.properties[options.statisticsColumn])
					}
				});
		}


		//geojson is a feature
		if(geojson.type.toUpperCase()=='FEATURE'){
				var temp=parseFeature(0, geojson, true);
				obj.columns=temp.columns;
				obj.columns_dataTable=temp.columns_dataTable;
				obj.datas.push(temp.datas);
		}




		//googleChartData
		obj.googleChartData=obj.datas.slice(0);
		obj.googleChartData.splice(0,0,obj.columns);

		return obj;


		//parse Feature
		function parseFeature(i, feature, needColumns){
			var columns_dataTable=[], columns=[], datas=[];
			datas[0]=i+1; //for ID
			if(needColumns){
				columns_dataTable[0]={"sTitle": "ID"}
				columns[0]="ID";
			}

			//if (!options.orderedColumns) {
			$.each(feature.properties, function(k,v){
				//check if td contains http hyperlink
				var hasHyperlink=false, value=String(v).toUpperCase();
				if(value.indexOf("HTTP://")>=0 || value.indexOf("HTTPS://")>=0){
					//start from http://
					v=hdma.util.linkify(String(v));
					hasHyperlink=true;
				}

				if(needColumns){
					var obj={"sTitle": k};

					if(hasHyperlink){
						obj.sType='html';
					}
					columns_dataTable.push(obj)
					columns.push(k);
				}
				datas.push(v);
			});


			//add coordinates
			if(feature.geometry.type=="Point"){
				if(needColumns){
					columns_dataTable.push({"sTitle": "Coordinates"});
					columns.push("Coordinates");
				};
				var lat=feature.geometry.coordinates[1].toFixed(3),
					lng=feature.geometry.coordinates[0].toFixed(3)

				datas.push(lng+", "+lat);
			}

			return {columns:columns, columns_dataTable:columns_dataTable, datas:datas}
		}
	},

	/**
	 * convert text to link if contains http, https, ftp, mailto
	 * from http://stackoverflow.com/questions/247479/jquery-text-to-link-script
	 * @param {String} content
	 */
	linkify: function(content){
		var url1 = /(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,
      		url2 = /(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g;

		content = content.replace(/&/g, '&amp;')
                         .replace(/</g, '&lt;')
                         .replace(/>/g, '&gt;')
                         .replace(url1, '$1<a target="_blank" href="http://$2">$2</a>$3')
                         .replace(url2, '$1<a target="_blank" href="$2">$2</a>$5');

		return content
	},




	/**
	 * create wordcloud
	 */
	//create wordCloud  beta
	createWordCloud: function(cloudtexts, $target, options) {
				var $target,
					colors = d3.scale.category20b(),
					maxcount = 0;


				//options
				if(!options){options={}}
				var width=options.width=options.width || $(document).width()
				var height=options.height=options.height || 400

				//find max
				for (var indx in cloudtexts)
					if (cloudtexts[indx].count > maxcount)  { maxcount = cloudtexts[indx].count;}

				//data
				var data=cloudtexts.map(function(d){
					return {text: d.value, size: Math.sqrt(d.count/maxcount *100)*10};
				})


				if (!app.wordcloud) {
					app.wordcloud = d3.layout.cloud().size([width, height])
						.words(data)
						.rotate(function() { return ~~(Math.random() * 1) * 90; })
						.font("Impact")
						.spiral("archimedean")
						//.spiral("rectangular")
						.fontSize(function(d) { return d.size; })
						.on("end", draw)
						.start();


				} else {
					app.wordcloud.stop().words(data).on("end", draw).start();
				}



			function search(keyword) {
					console.log(keyword);
			}


			function draw(words) {
				//d3.select("svg").remove();
				d3.select($target.selector).append("svg")
					.attr("width", width)
					.attr("height", height)
					.attr("style", "border-color:lightgray;border-style:solid;border-width:0px;")
					.attr("viewBox","0 0 "+width+" "+ height)
  					.attr("preserveAspectRatio", "xMidYMid")
					.append("g")
					.attr("transform", "translate(" + (width/2) + "," + (height/2) + ")")
					.selectAll("text")
					.data(words)
					.enter().append("text")
					.style("font-size", function(d) { return d.size + "px"; })
					.style("font-family", "Impact")
					.attr("text-anchor", "middle")
					.attr("transform", function(d) {
						return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
					})
					.text(function(d) { return d.text; });

				$("text").css("fill", function() { return colors(this.__data__.text.toLowerCase()); })

				$("text").click(function() { search(this.__data__.text); }).css("cursor", "pointer")
						//.mouseover(function() { $(this).css("fill", "#cc2222"); })
						.mouseover(function() { $(this).css("fill", "#22aa22"); })
						.mouseout(function() { $(this).css("fill", colors(this.__data__.text.toLowerCase())); });

			}

	},

	// Porter stemmer in Javascript. Few comments, but it's easy to follow against the rules in the original
	// paper, in
	//
	//  Porter, 1980, An algorithm for suffix stripping, Program, Vol. 14,
	//  no. 3, pp 130-137,
	//
	// see also http://www.tartarus.org/~martin/PorterStemmer

	// Release 1 be 'andargor', Jul 2004
	// Release 2 (substantially revised) by Christopher McKenzie, Aug 2009
	stemmer: function(w){
		var step2list = {
				"ational" : "ate",
				"tional" : "tion",
				"enci" : "ence",
				"anci" : "ance",
				"izer" : "ize",
				"bli" : "ble",
				"alli" : "al",
				"entli" : "ent",
				"eli" : "e",
				"ousli" : "ous",
				"ization" : "ize",
				"ation" : "ate",
				"ator" : "ate",
				"alism" : "al",
				"iveness" : "ive",
				"fulness" : "ful",
				"ousness" : "ous",
				"aliti" : "al",
				"iviti" : "ive",
				"biliti" : "ble",
				"logi" : "log"
			},

			step3list = {
				"icate" : "ic",
				"ative" : "",
				"alize" : "al",
				"iciti" : "ic",
				"ical" : "ic",
				"ful" : "",
				"ness" : ""
			},

			c = "[^aeiou]",          // consonant
			v = "[aeiouy]",          // vowel
			C = c + "[^aeiouy]*",    // consonant sequence
			V = v + "[aeiou]*",      // vowel sequence

			mgr0 = "^(" + C + ")?" + V + C,               // [C]VC... is m>0
			meq1 = "^(" + C + ")?" + V + C + "(" + V + ")?$",  // [C]VC[V] is m=1
			mgr1 = "^(" + C + ")?" + V + C + V + C,       // [C]VCVC... is m>1
			s_v = "^(" + C + ")?" + v;                   // vowel in stem


			var stem,
				suffix,
				firstch,
				re,
				re2,
				re3,
				re4,
				origword = w;

			if (w.length < 3) { return w; }

			firstch = w.substr(0,1);
			if (firstch == "y") {
				w = firstch.toUpperCase() + w.substr(1);
			}

			// Step 1a
			re = /^(.+?)(ss|i)es$/;
			re2 = /^(.+?)([^s])s$/;

			if (re.test(w)) { w = w.replace(re,"$1$2"); }
			else if (re2.test(w)) {	w = w.replace(re2,"$1$2"); }

			// Step 1b
			re = /^(.+?)eed$/;
			re2 = /^(.+?)(ed|ing)$/;
			if (re.test(w)) {
				var fp = re.exec(w);
				re = new RegExp(mgr0);
				if (re.test(fp[1])) {
					re = /.$/;
					w = w.replace(re,"");
				}
			} else if (re2.test(w)) {
				var fp = re2.exec(w);
				stem = fp[1];
				re2 = new RegExp(s_v);
				if (re2.test(stem)) {
					w = stem;
					re2 = /(at|bl|iz)$/;
					re3 = new RegExp("([^aeiouylsz])\\1$");
					re4 = new RegExp("^" + C + v + "[^aeiouwxy]$");
					if (re2.test(w)) {	w = w + "e"; }
					else if (re3.test(w)) { re = /.$/; w = w.replace(re,""); }
					else if (re4.test(w)) { w = w + "e"; }
				}
			}

			// Step 1c
			re = /^(.+?)y$/;
			if (re.test(w)) {
				var fp = re.exec(w);
				stem = fp[1];
				re = new RegExp(s_v);
				if (re.test(stem)) { w = stem + "i"; }
			}

			// Step 2
			re = /^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/;
			if (re.test(w)) {
				var fp = re.exec(w);
				stem = fp[1];
				suffix = fp[2];
				re = new RegExp(mgr0);
				if (re.test(stem)) {
					w = stem + step2list[suffix];
				}
			}

			// Step 3
			re = /^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/;
			if (re.test(w)) {
				var fp = re.exec(w);
				stem = fp[1];
				suffix = fp[2];
				re = new RegExp(mgr0);
				if (re.test(stem)) {
					w = stem + step3list[suffix];
				}
			}

			// Step 4
			re = /^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/;
			re2 = /^(.+?)(s|t)(ion)$/;
			if (re.test(w)) {
				var fp = re.exec(w);
				stem = fp[1];
				re = new RegExp(mgr1);
				if (re.test(stem)) {
					w = stem;
				}
			} else if (re2.test(w)) {
				var fp = re2.exec(w);
				stem = fp[1] + fp[2];
				re2 = new RegExp(mgr1);
				if (re2.test(stem)) {
					w = stem;
				}
			}

			// Step 5
			re = /^(.+?)e$/;
			if (re.test(w)) {
				var fp = re.exec(w);
				stem = fp[1];
				re = new RegExp(mgr1);
				re2 = new RegExp(meq1);
				re3 = new RegExp("^" + C + v + "[^aeiouwxy]$");
				if (re.test(stem) || (re2.test(stem) && !(re3.test(stem)))) {
					w = stem;
				}
			}

			re = /ll$/;
			re2 = new RegExp(mgr1);
			if (re.test(w) && re2.test(w)) {
				re = /.$/;
				w = w.replace(re,"");
			}

			// and turn initial Y back to y

			if (firstch == "y") {
				w = firstch.toLowerCase() + w.substr(1);
			}

		return w;

	},

	/**
	 *  shade color from http://stackoverflow.com/questions/5560248/programmatically-lighten-or-darken-a-hex-color-or-rgb-and-blend-colors
	 */
	shadeColor: function(color, percent) {
    var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
    return "#"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);
	}




}
